name: Blog RSS Sync & Sitemap Update

on:
  schedule:
    # Her 6 saatte bir RSS kontrol et (gÃ¼nde 4 kez: 00:00, 06:00, 12:00, 18:00)
    - cron: "0 */6 * * *"

  # Manuel trigger iÃ§in
  workflow_dispatch:

# GitHub Actions permissions
permissions:
  contents: write

jobs:
  sync-blog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Sync RSS and Update Blog Data & Sitemap
        id: sync
        run: |
          echo "Running RSS sync..."
          if node scripts/sync-rss.js; then
            echo "sync_status=success" >> $GITHUB_OUTPUT
            echo "âœ… RSS sync completed successfully"
          else
            exit_code=$?
            case $exit_code in
              0)
                echo "sync_status=no_changes" >> $GITHUB_OUTPUT
                echo "â„¹ï¸  No changes detected, skipping commit"
                ;;
              2)
                echo "sync_status=not_ready" >> $GITHUB_OUTPUT
                echo "â¸ï¸  Blog RSS not ready yet, skipping sync"
                ;;
              *)
                echo "sync_status=failed" >> $GITHUB_OUTPUT
                echo "âŒ RSS sync failed with exit code: $exit_code"
                exit 1
                ;;
            esac
          fi
        env:
          # Blogspot RSS URL (kullanÄ±cÄ± tarafÄ±ndan ayarlanacak)
          RSS_URL: ${{ secrets.BLOGSPOT_RSS_URL || 'https://gulsevenucerler.blogspot.com/feeds/posts/default?alt=rss' }}

      - name: Check for Changes
        id: changes
        if: steps.sync.outputs.sync_status == 'success'
        run: |
          if git diff --exit-code --quiet public/blog-data.json src/assets/blog-data.json public/sitemap.xml; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No file changes detected (this shouldn't happen after successful sync)"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in blog data and sitemap"
            echo "ğŸ“„ Modified files:"
            git diff --name-only public/blog-data.json src/assets/blog-data.json public/sitemap.xml || true
          fi

      - name: Commit and Push Changes
        if: steps.sync.outputs.sync_status == 'success' && steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action [Blog Sync]"

          # Blog data ve sitemap dosyalarÄ±nÄ± stage'e al
          git add public/blog-data.json src/assets/blog-data.json public/sitemap.xml

          # DeÄŸiÅŸen dosya sayÄ±sÄ±nÄ± hesapla
          CHANGED_FILES=$(git diff --cached --name-only | wc -l)

          # Commit mesajÄ±nÄ± oluÅŸtur
          COMMIT_MSG="ğŸ†• Update blog content and sitemap

          ğŸ“ New blog posts detected from RSS feed
          ğŸ“„ Updated files: blog-data.json, sitemap.xml
          ğŸ¤– Auto-sync triggered by: ${{ github.event_name }}
          ğŸ“Š Files changed: $CHANGED_FILES

          [skip ci]"

          git commit -m "$COMMIT_MSG"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Deployment kÄ±smÄ± kaldÄ±rÄ±ldÄ± - deploy.yml bunu hallediyor

      - name: Workflow Summary
        run: |
          case "${{ steps.sync.outputs.sync_status }}" in
            "success")
              if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
                echo "ğŸ‰ Blog sync completed successfully!"
                echo "ğŸ“ New blog content detected and updated"
                echo "ğŸš€ Changes committed and pushed to main branch"
                echo "ğŸ“„ Updated files:"
                echo "  âœ… public/blog-data.json"
                echo "  âœ… src/assets/blog-data.json"
                echo "  âœ… public/sitemap.xml"
              else
                echo "âš ï¸  Sync completed but no file changes detected"
                echo "ğŸ“„ This might indicate an issue with the sync process"
              fi
              ;;
            "no_changes")
              echo "â„¹ï¸  Blog sync completed - No new content available"
              echo "ğŸ“„ RSS feed content is already up to date"
              echo "ğŸ’¾ Existing blog data preserved"
              ;;
            "not_ready")
              echo "â¸ï¸  Blog RSS sync skipped - Content not ready yet"
              echo "ğŸ”— RSS feed is not available or contains no posts"
              echo "ğŸ“… This is normal if blog content hasn't been added yet"
              echo "ğŸ”„ Sync will automatically retry on next scheduled run"
              echo "ğŸ’¡ No action needed - workflow will resume once blog is ready"
              ;;
            "failed")
              echo "âŒ Blog sync failed"
              echo "ğŸ” Check RSS feed availability and format"
              echo "ğŸ“¡ RSS URL: ${{ env.RSS_URL }}"
              ;;
            *)
              echo "â“ Unknown sync status: ${{ steps.sync.outputs.sync_status }}"
              ;;
          esac
